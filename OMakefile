USE_OCAMLFIND = true
NATIVE_ENABLED = true
BYTE_ENABLED = true

OCAMLDEPFLAGS = -pp "camlp4orf"
OCAMLFLAGS = -dtypes -pp "camlp4orf" -w A -warn-error A
OCAMLOPTFLAGS = -S -inline 100
OCAMLCFLAGS += -g

OCAMLPACKS[] =
	camlp4
	extlib

CamlSources(mods) =
	foreach(mod, $(mods))
		$(addsuffixes .cmo .cmi .cmx .sig $(EXT_OBJ), $(mod)):

CamlTargets(mod) =
	return($(addsuffixes .cmo .cmi .cmx .o, $(mod)))

.SUBDIRS: runtime test

EXTPROT_OBJS[] =
	parser
	ptypes
	gencode
	gen_OCaml

section
	OCAMLINCLUDES[] += runtime
	section
		OCAMLFLAGS += -for-pack Extprot_gen
		CamlSources($(EXTPROT_OBJS))
	section
		OCAMLFLAGS += -for-pack Extprot_gen -w e
		CamlSources(parser)
	OCamlPackage(extprot_gen, $(EXTPROT_OBJS))
	OCamlLibrary(extprot_gen, extprot_gen)

section
	OCAML_LIBS = runtime/extprot extprot_gen
	OCAMLPACKS += camlp4.lib
	OCamlProgram(sample, sample)

%.sig: %.ml %.cmo
	$(OCAMLFIND) $(OCAMLC) -package $(concat \,, $(OCAMLPACKS)) \
	    $(mapprefix -I, $(OCAMLINCLUDES)) \
	    $(OCAMLFLAGS) $(OCAMLCFLAGS) -i $< > $@

.DEFAULT: extprot_gen.cma extprot_gen.cmxa sample

.PHONY: clean
clean:
	rm -f $(filter-proper-targets $(ls R, .))

